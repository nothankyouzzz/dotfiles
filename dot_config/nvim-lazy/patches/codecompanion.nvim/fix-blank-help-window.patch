From 4ea4817869a544acd786f8875b1f30733303a151 Mon Sep 17 00:00:00 2001
From: nothankyou <luxun070188@outlook.com>
Date: Tue, 9 Sep 2025 17:39:11 +0800
Subject: [PATCH] fix(ui): properly close floating window before deleting
 buffer

Ensure the floating window is closed with `nvim_win_close` before
attempting to delete the buffer, and check buffer validity to prevent
errors.
---
 lua/codecompanion/utils/ui.lua | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/lua/codecompanion/utils/ui.lua b/lua/codecompanion/utils/ui.lua
index 136fa50..eb5918f 100644
--- a/lua/codecompanion/utils/ui.lua
+++ b/lua/codecompanion/utils/ui.lua
@@ -56,7 +56,10 @@ M.create_float = function(lines, opts)
   end
 
   local function close()
-    api.nvim_buf_delete(bufnr, { force = true })
+    api.nvim_win_close(winnr, true)
+    if api.nvim_buf_is_valid(bufnr) then
+      api.nvim_buf_delete(bufnr, { force = true })
+    end
   end
 
   vim.keymap.set("n", "q", close, { buffer = bufnr })
-- 
2.43.0

